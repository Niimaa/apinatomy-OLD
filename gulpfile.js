'use strict';

var baseDirOption = { base: process.cwd() };

////////////////////////////////////////////////////////////////////////////////////////////////////

var _          = require('lodash');
var gulp       = require('gulp');
var typescript = require('gulp-tsc');
var compass    = require('gulp-compass');
var shell      = require('gulp-shell');
var util       = require('./gulp-util');

////////////////////////////////////////////////////////////////////////////////////////////////////
//  typescript                                                                                    //
////////////////////////////////////////////////////////////////////////////////////////////////////
//  in:  *.ts
// out:  *.ts.js
//       *.ts.js.map
//       *.d.ts

util.register('typescript', 'client/**/*.ts', function (stream) {
	return stream
			.pipe(typescript({ target: 'ES5', sourcemap: true }))
			.pipe(util.rename(function (file) {
				if (file.extname === '.js' ||
				    file.extname === '.js.map') { file.basename += '.ts' }
			}));
});

////////////////////////////////////////////////////////////////////////////////////////////////////
//  compass                                                                                       //
////////////////////////////////////////////////////////////////////////////////////////////////////

//util.register('compass', ['client/**/*.scss', '!client/**/_*', '!client/lib/**/*'], function (stream) {
//	return stream
//			.pipe(compass({
//				// ?
//			}))
//});

////////////////////////////////////////////////////////////////////////////////////////////////////
//  jquery-ui AMD                                                                                 //
////////////////////////////////////////////////////////////////////////////////////////////////////

gulp.task('jquery-ui-amd', shell.task("./node_modules/.bin/jqueryui-amd client/lib/jquery-ui"));

////////////////////////////////////////////////////////////////////////////////////////////////////
// watch (all)                                                                                    //
////////////////////////////////////////////////////////////////////////////////////////////////////

gulp.task('watch', _(gulp.tasks).pluck('name').filter(function (taskName) {
	return taskName.substr(0, 6) === 'watch-';
}).value());

////////////////////////////////////////////////////////////////////////////////////////////////////
// default                                                                                        //
////////////////////////////////////////////////////////////////////////////////////////////////////

gulp.task('default', ['typescript', 'jquery-ui-amd', 'watch']);
