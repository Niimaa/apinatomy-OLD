'use strict';

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
define(['lodash', 'angular', 'app/module',
        '$bind/service',
        'defaults/service',
        'partial/treemap/directive',
        'partial/circuit-board/tile/directive',
        'partial/tile-map/directive'
], function (_, ng, app) {
//  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	app.directive('amyCircuitBoard', ['ResourceService', 'defaults', function (ResourceService, defaults) {


		////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////


		var generateTileMapDefaults = defaults({
			layout:  " 'rowsOfTiles' ",
			spacing: " 2 "
		});


		////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////


		return {
			restrict:    'E',
			replace:     false,
			templateUrl: 'partial/circuit-board/view.html',
			scope: {
				entity: '='
			},

			////////////////////////////////////////////////////////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////////////////////////////////////////////////////////

			controller: ['$scope', function ($scope) {

				//////////////////// TileMap / Artefact Hierarchy //////////////////////////////////////////////////////

				$scope.tileMap =
				$scope.artefact = {
					id:           $scope.$id,
					type:         'tileMap',

					//// artefact hierarchy:
					parent:       $scope.$parent.artefact,
					children:     [],
					root:         $scope.$parent.artefact.root
				};


				//////////////////// Loading sub-entities //////////////////////////////////////////////////////////////

				$scope.entity._promise.then(function () {
					ResourceService.entities(_($scope.entity.sub).map(function (sub) {
						return sub.entity._id;
					}).value());
				});

			}],

			////////////////////////////////////////////////////////////////////////////////////////////////////////////

			compile: function () {
				return {

					pre: function preLink($scope/*, iElement, iAttrs, controller*/) {

						$scope.entity._promise.then(function () {

							//// Styling

							$scope.styling = generateTileMapDefaults($scope.entity.tileMap, {});

						});


					},

					post: function postLink(/*$scope, iElement, iAttrs, controller*/) {}

				};
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////////////
		};
	}]);


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
});/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
