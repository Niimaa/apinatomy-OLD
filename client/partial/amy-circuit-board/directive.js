'use strict';

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
define(['app/module', 'lodash', 'resource/service',
        'partial/amy-circuit-board/amy-tile-map/directive',
        'partial/amy-circuit-board/amy-tile/directive'], function (app, _) {
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	app.directive('amyCircuitBoard', ['ResourceService', function (ResourceService) {
		return {
			////////////////////////////////////////////////////////////////////////////////////////////////////////////

			restrict:    'E',
			replace:     true,
			templateUrl: 'partial/amy-circuit-board/view.html',
			require:     'ngModel',
			scope:       true,

			////////////////////////////////////////////////////////////////////////////////////////////////////////////

			compile: function () {
				return {
					pre: function preLink($scope, iElement, iAttrs, ngModel) {
						iElement.attr('amy-circuit-board', '');

						//////////////////// Getting the model value ///////////////////////////////////////////////////

						ngModel.$render = function () {
							$scope.entity = ngModel.$modelValue;

							//////////////////// Artefact Hierarchy ////////////////////////////////////////////////////

							$scope.circuitBoard =
							$scope.artefact = {
								id:       $scope.$id,
								type:     'circuitBoard',
								show:     false,

								//// artefact hierarchy:
								parent:   $scope.$parent.artefact,
								children: [],

								//// root entity:
								entity:   ResourceService.entities(['24tile:60000000'])[0]
							};


							//// Announce this artefact to its parent.
							//
							$scope.artefact.parent.children.push($scope.artefact);


							//// Remove references to this tile when it is destroyed.
							//
							$scope.$on('$destroy', function () {
								_($scope.tile.parent).pull($scope.tile);
							});

						}
					}
				};
			}

			////////////////////////////////////////////////////////////////////////////////////////////////////////////
		};
	}]);


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
});/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
